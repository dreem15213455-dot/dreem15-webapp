<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreem15 - Sapno ki Udaan</title>
    
    <!-- ‚úÖ FIXED: Manifest path corrected -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff0000">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <!-- ‚úÖ FIXED: Service Worker path corrected -->
    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')  // ‚úÖ CHANGED FROM '/sw.js' TO './sw.js'
              .then(registration => {
                console.log('ServiceWorker registered:', registration.scope);
              })
              .catch(error => {
                console.error('ServiceWorker registration failed:', error);
              });
          });
        }
    </script>
    
    <style>
        /* CSS is mostly unchanged, plus new styles for Bottom Nav, Leaderboard, and Golden Card */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            /* Added padding for bottom nav - increased size due to 4 items now */
            padding-bottom: 60px; 
        }
        
        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff0000, #cc0000);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        #splash-screen h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        #splash-screen p {
            font-size: 1.2rem;
            text-align: center;
            max-width: 80%;
        }
        
        /* Login/Signup Page */
        #auth-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff0000, #cc0000);
            z-index: 999;
            padding: 20px;
            justify-content: center;
            align-items: center;
        }
        
        .auth-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .auth-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff0000;
        }
        
        .auth-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .auth-container button {
            width: 100%;
            padding: 12px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.3s ease;
        }
        
        .auth-container button:disabled {
            background: #ff9999; 
            cursor: not-allowed;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 2px solid #ddd;
        }
        
        .auth-tab.active {
            border-bottom: 2px solid #ff0000;
            color: #ff0000;
            font-weight: bold;
        }
        
        /* Home Page */
        #home-page {
            display: none;
        }
        
        /* Header */
        .header {
            background-color: #ff0000;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .header-icons {
            display: flex;
            gap: 15px;
        }
        
        .header-icons i {
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* Side Menu */
        .side-menu {
            position: fixed;
            left: -280px;
            width: 280px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 200;
            transition: left 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }
        
        .side-menu.active {
            left: 0;
        }
        
        .side-menu h3 {
            margin-bottom: 20px;
            color: #ff0000;
            text-align: center;
        }
        
        .side-menu ul {
            list-style: none;
        }
        
        .side-menu li {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .side-menu li i {
            margin-right: 10px;
            color: #ff0000;
        }

        /* Social Icons in Menu */
        .social-icons-menu {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-top: 1px solid #eee;
            margin-top: 15px;
        }

        .social-icons-menu i {
            font-size: 1.5rem;
            color: #555;
            cursor: pointer;
        }
        
        /* Terms and Conditions Modal */
        .terms-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 400;
            justify-content: center;
            align-items: center;
        }

        .terms-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            padding: 25px;
            position: relative;
            overflow-y: auto;
        }

        .terms-content h2 {
            color: #ff0000;
            margin-bottom: 15px;
            text-align: center;
        }

        .terms-content p, .terms-content li {
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 10px;
            color: #555;
        }

        .terms-content ul {
            padding-left: 20px;
        }
        
        /* Profile Page */
        #profile-page {
            display: none;
            padding: 20px;
            padding-bottom: 70px; /* Space for bottom nav */
        }
        
        .profile-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            background: #ff0000;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto 15px;
        }
        
        .profile-info {
            margin-bottom: 15px;
        }
        
        .profile-info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        /* Wallet Modal */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }
        
        .wallet-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
        }
        
        .wallet-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .wallet-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 2px solid #ddd;
        }
        
        .wallet-tab.active {
            border-bottom: 2px solid #ff0000;
            color: #ff0000;
            font-weight: bold;
        }
        
        .wallet-section {
            display: none;
            max-height: 400px; 
            overflow-y: auto;
        }
        
        .wallet-section.active {
            display: block;
        }
        
        .wallet-balance {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .wallet-balance h3 {
            color: #ff0000;
            margin-bottom: 5px;
        }
        
        .wallet-balance p {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .wallet-btn {
            width: 100%;
            padding: 12px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        
        .wallet-btn:disabled {
            background: #ff9999;
            cursor: not-allowed;
        }

        /* Deposit History Styles */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            background: #f9f9f9;
            border-left: 5px solid;
        }

        .history-item.Pending {
            border-left-color: #ffc107;
            background: #fffbe6;
        }

        .history-item.Verified {
            border-left-color: #28a745;
            background: #e6ffed;
        }

        .history-item.Rejected {
            border-left-color: #dc3545;
            background: #ffe6e6;
        }

        .history-status {
            font-weight: bold;
            font-size: 0.9em;
        }

        /* Slider */
        .slider {
            height: 96px;
            overflow: hidden;
            position: relative;
            margin: 10px 0;
        }
        
        .slides {
            display: flex;
            transition: transform 0.5s ease;
            height: 100%;
        }
        
        .slide {
            min-width: 100%;
            height: 100%;
            background: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #ff0000;
            background-size: cover; 
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* Services - NO LONGER USED, but keeping the class for structure */
        .services {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            padding: 15px 0;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            margin: 10px 0;
        }
        
        .service-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 25%;
            margin-bottom: 15px;
            cursor: pointer; 
        }
        
        .service-icon {
            width: 50px;
            height: 50px;
            background: #ff0000;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            margin-bottom: 5px;
        }
        
        .service-name {
            font-size: 0.8rem;
            text-align: center;
        }
        
        /* Invite Card (ISSUE 1 FIX APPLIED HERE: Color changed to RED) */
        .invite-card {
            background: #ff0000; /* CHANGED FROM #4CAF50 TO RED */
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px;
            text-align: center;
        }
        
        .invite-card h3 {
            margin-bottom: 10px;
        }
        
        .invite-card p {
            margin-bottom: 15px;
        }
        
        .invite-btn {
            background: white;
            color: #ff0000; /* CHANGED FROM #4CAF50 TO RED */
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Share Modal */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }
        
        .share-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            text-align: center;
            position: relative; 
        }
        
        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .share-option:hover {
            background: #f5f5f5;
        }
        
        .share-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .whatsapp { color: #25D366; }
        .facebook { color: #1877F2; }
        .telegram { color: #0088cc; }
        .sms { color: #ff0000; }
        .email { color: #EA4335; }
        .copy { color: #666; }
        
        /* Contest Cards */
        .contest-section {
            padding: 15px;
        }
        
        .contest-section h2 {
            margin-bottom: 15px;
            color: #ff0000;
        }
        
        .contest-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .contest-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .contest-prize {
            font-weight: bold;
            color: #ff0000;
        }
        
        .contest-timer { 
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        /* NEW STYLES for Issue 2 */
        .contest-timer-details {
             display: flex;
             flex-direction: column;
             align-items: flex-end;
             font-size: 0.8rem;
        }
        .contest-timer-details .draw-date {
             font-size: 0.75rem;
             color: #007bff;
             margin-top: 2px;
             font-weight: bold;
        }

        .contest-image {
            width: 100%;
            height: 150px;
            background: #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .contest-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        /* NEW STYLE for First Prize */
        .contest-first-prize {
             font-weight: bold;
             color: #28a745; /* Changed to Green */
             font-size: 1.3rem; /* Increased size */
             margin-top: 5px;
        }
        
        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #4CAF50;
            width: 60%;
        }
        
        .join-btn {
            background: #ff0000;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px; /* Added margin for separation */
        }
        
        /* New Joined Button State */
        .join-btn[disabled], .join-btn.already-joined {
            background: #ccc !important;
            cursor: not-allowed;
        }

        /* Contest Fee Display Styles */
        .contest-fee {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-top: 1px dashed #ddd;
        }

        .contest-fee-label {
            font-size: 1rem;
            font-weight: 500;
            color: #555;
        }

        .contest-fee-amount {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4CAF50; /* Free is green */
        }
        
        .contest-fee-amount.paid {
            color: #ff0000; /* Paid is red */
        }

        /* Quiz Page & Results Popup */
        #quiz-page {
            display: none;
            padding: 15px;
        }
        
        /* NEW: English Course Page Styles (Basic) */
        #english-course-page {
            display: none;
            padding: 15px;
            padding-bottom: 70px;
        }

        .results-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 150;
        }
        
        .overlay.active {
            display: block;
        }

        /* 1) PREMIUM ENGLISH COURSE CARD STYLES */
        .english-course-card {
            /* Changed to Red Gradient */
            background: linear-gradient(135deg, #ff0000, #cc0000); 
            color: white; 
            font-weight: bold; 
            border-radius: 10px;
            padding: 15px;
            margin: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            position: relative;
        }
        
        .english-course-card h3 {
            color: #ffeb3b; /* Yellow for premium look */
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .english-course-card p {
            font-size: 1rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .course-purchase-btn {
            /* Changed to Green */
            background: #4CAF50; 
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            transition: background 0.3s ease;
        }
        
        .course-purchase-btn:hover {
            background: #388E3C; /* Darker green on hover */
        }
        
        /* Payment Gateway */
        .payment-gateway {
            text-align: center;
            padding: 20px 0 0 0; 
        }
        
        .payment-btn {
            width: 100%; 
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        /* NEW: English Course Card (Replacing Service Icons - Point 2) */
        .english-course-service-card {
            background: linear-gradient(135deg, #4CAF50, #388E3C); /* Green Gradient */
            color: white; 
            border-radius: 10px;
            padding: 20px;
            margin: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            cursor: pointer;
        }

        .english-course-service-card i {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .english-course-service-card h4 {
            font-size: 1.2rem;
            margin: 0;
        }

        /* NEW: Bottom Navigation Bar CSS */
        .bottom-nav {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 500;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: #ff0000;
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .nav-item span {
            font-size: 0.7rem;
        }

        /* NEW: Leaderboard Specific CSS */
        #leaderboard-page {
            display: none;
            padding-bottom: 70px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            font-size: 1rem;
        }
        
        .leaderboard-entry.user-highlight {
            background-color: #fff3f3; /* Light red background */
            border-left: 5px solid #ff0000;
            font-weight: bold;
        }
        
        .leaderboard-entry-rank {
            width: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .leaderboard-entry-name {
            flex-grow: 1;
            margin-left: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .leaderboard-entry-points {
            font-weight: bold;
            color: #4CAF50;
        }
        
        /* NEW: Joined Contest Card */
        #my-contests-page {
            display: none;
            padding: 15px;
            padding-bottom: 70px; 
        }
        
        .joined-contest-card {
            background: white;
            border-left: 5px solid #007bff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .joined-contest-card h4 {
            color: #007bff;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .joined-contest-card p {
            font-size: 0.9rem;
            color: #555;
            margin-top: 5px;
        }
        .joined-contest-card .status {
            font-weight: bold;
            font-size: 0.95rem;
        }
        .joined-contest-card .points {
            font-weight: bold;
            color: #ff0000;
        }

        /* NEW: Prize Structure Styles */
        .prize-structure {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }

        .prize-structure h4 {
            color: #28a745;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .prize-rank {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 0.85rem;
        }

        .prize-rank:last-child {
            border-bottom = none;
        }

        .prize-rank-number {
            font-weight: bold;
            color: #007bff;
        }

        .prize-rank-amount {
            font-weight: bold;
            color: #28a745;
        }

    </style>
</head>
<body>
    <div id="splash-screen">
        <h1>Dreem15</h1>
        <p>Sapno ki Udaan</p>
    </div>
    
    <div id="auth-page">
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" id="login-tab">Login</div>
                <div class="auth-tab" id="signup-tab">Sign Up</div>
            </div>
            
            <div id="login-form">
                <h2>Login to Dreem15</h2>
                <input type="email" id="login-email" placeholder="Email Address">
                <input type="password" id="login-password" placeholder="Password">
                <button id="login-btn">Login</button>
            </div>
            
            <div id="signup-form" style="display: none;">
                <h2>Create Account</h2>
                <input type="text" id="signup-name" placeholder="Full Name">
                <input type="email" id="signup-email" placeholder="Email Address">
                <input type="password" id="signup-password" placeholder="Password">
                <input type="text" id="signup-referral-code" placeholder="Referral Code (Optional)"> 
                <button id="signup-btn">Sign Up</button>
            </div>
        </div>
    </div>
    
    <div id="home-page">
        <div class="header">
            <i class="fas fa-bars" id="menu-toggle"></i>
            <h1>Dreem15</h1>
            <div class="header-icons">
                <i class="fas fa-wallet" id="wallet-icon"></i>
            </div>
        </div>
        
        <div class="side-menu" id="side-menu">
            <h3>Menu</h3>
            <ul>
                <li onclick="showProfile()"><i class="fas fa-user"></i> Profile</li>
                <li onclick="showWallet()"><i class="fas fa-wallet"></i> Wallet</li>
                <li onclick="showComingSoon('Help & Services')"><i class="fas fa-question-circle"></i> Help & Services</li>
                <li onclick="showShareModal()"><i class="fas fa-gift"></i> Refer & Earn</li>
                <li onclick="showTermsModal()"><i class="fas fa-file-contract"></i> English Course Terms</li> 
                <li onclick="showComingSoon('Settings')"><i class="fas fa-cog"></i> Settings</li>
                <li onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
            <div class="social-icons-menu">
                <i class="fab fa-facebook" onclick="showComingSoon('Facebook')"></i>
                <i class="fab fa-instagram" onclick="showComingSoon('Instagram')"></i>
                <i class="fab fa-twitter" onclick="showComingSoon('Twitter')"></i>
            </div>
        </div>

        <div class="terms-modal" id="terms-modal">
            <div class="terms-content">
                <button class="close-btn" id="close-terms" onclick="closeTermsModal()">&times;</button>
                <h2>Premium English Course Terms</h2>
                
                <p>By purchasing the **Premium English Course**, you agree to the following terms:</p>

                <p style="font-weight: bold; margin-top: 15px; color: #ff0000;">‚ö†Ô∏è Important Information:</p>
                <ul>
                    <li>Course Fee is non-refundable.</li>
                    <li>**Access is NOT automatic**; it will be granted only after **Admin Verification** of your payment (via UTR submission).</li>
                    <li>The content is for your **personal, educational use** only. Sharing or redistribution is strictly prohibited and will result in permanent account termination.</li>
                    <li>The course is accessible via the **'English Course'** tab once unlocked.</li>
                </ul>
                
                <p style="text-align: center; font-weight: bold; margin-top: 20px; color: #007bff;">By proceeding with the purchase, you confirm that you accept these terms.</p>
            </div>
        </div>
        
        <div id="profile-page">
            <div class="profile-card">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <h2 id="profile-name">Loading...</h2>
                <p id="profile-email">Loading...</p>
            </div>
            
            <div class="profile-card">
                <h3>Account Information</h3>
                <div class="profile-info">
                    <div class="profile-info-item">
                        <span>Joined Date:</span>
                        <span id="profile-joined">Loading...</span>
                    </div>
                    <div class="profile-info-item">
                        <span>Referral Code:</span>
                        <span id="profile-referral">Loading...</span>
                    </div>
                    <div class="profile-info-item">
                        <span>Total Referrals:</span>
                        <span id="profile-referrals">0</span>
                    </div>
                    <div class="profile-info-item">
                        <span>English Course Status:</span>
                        <span id="course-status" style="font-weight: bold; color: #ff0000;">Pending/Locked</span>
                    </div>
                </div>
            </div>
            
            <button class="wallet-btn" onclick="showHome()">Back to Home</button>
        </div>
        
        <div class="wallet-modal" id="wallet-modal">
            <div class="wallet-content">
                <button class="close-btn" id="close-wallet">&times;</button>
                <div class="wallet-balance">
                    <h3>Your Wallet Balance</h3>
                    <p id="wallet-balance-amount">‚Çπ0.00</p>
                </div>
                
                <div class="wallet-tabs">
                    <div class="wallet-tab active" id="deposit-tab">Deposit</div>
                    <div class="wallet-tab" id="withdraw-tab">Withdraw</div>
                    <div class="wallet-tab" id="history-tab">History</div> 
                </div>
                
                <div class="wallet-section active" id="deposit-section">
                    <h3>Step 1: Amount Daalein</h3>
                    
                    <div class="form-group">
                        <label for="deposit-amount">Amount (‚Çπ)</label>
                        <input type="number" id="deposit-amount" placeholder="Enter amount">
                    </div>
                    
                    <div class="payment-gateway">
                        <p>Click below to pay via Razorpay/UPI:</p>
                        <button class="payment-btn" id="open-razorpay-btn" onclick="openRazorpayLink()">
                            Pay Now via Razorpay
                        </button>
                    </div>

                    <hr style="margin: 20px 0; border-top: 1px solid #ddd;">
                    
                    <h3>Step 2: UTR Submit Karein</h3>
                    <p style="font-size: 0.9em; color: #ff0000; margin-bottom: 10px;">Payment hone ke baad, wapas is page par aakar niche UTR/Transaction ID daalein‡•§</p>
                    
                    <div class="form-group">
                        <label for="deposit-utr">Transaction/UTR ID (10-18 Digits)</label>
                        <input type="text" id="deposit-utr" placeholder="Enter UTR/Transaction ID after payment">
                    </div>
                    <button class="wallet-btn" id="submit-utr-btn" onclick="submitDepositUTR()">Submit UTR for Verification</button>
                    
                    <p style="font-size: 0.8em; color: #666; margin-top: 10px; text-align: center;">*Amount **Dreem Team** Verification ke baad ‡§π‡•Ä aapke wallet mein aayega‡•§</p>
                </div>
                
                <div class="wallet-section" id="withdraw-section">
                    <h3>Withdraw Funds</h3>
                    <p style="font-size: 0.9em; color: #ff0000; margin-bottom: 10px;">Kripya ya toh Bank Details (Account No, IFSC) bharein, ya sirf UPI ID bharein‡•§</p>
                    
                    <div class="form-group">
                        <label for="withdraw-amount">Amount (‚Çπ)</label>
                        <input type="number" id="withdraw-amount" placeholder="Enter amount">
                    </div>
                    <div class="form-group">
                        <label for="withdraw-name">Full Name</label>
                        <input type="text" id="withdraw-name" placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="withdraw-upi">UPI ID (e.g., user@bankname)</label>
                        <input type="text" id="withdraw-upi" placeholder="Enter UPI ID (Optional)">
                    </div>
                    <p style="text-align: center; margin: 10px 0; font-weight: bold; color: #333;">--- OR BANK DETAILS ---</p>

                    <div class="form-group">
                        <label for="withdraw-account">Bank Account Number</label>
                        <input type="text" id="withdraw-account" placeholder="Enter account number (Optional)">
                    </div>
                    <div class="form-group">
                        <label for="withdraw-ifsc">IFSC Code</label>
                        <input type="text" id="withdraw-ifsc" placeholder="Enter IFSC code (Optional)">
                    </div>
                    <div class="form-group">
                        <label for="withdraw-bank">Bank Name</label>
                        <select id="withdraw-bank">
                            <option value="">Select Bank (Optional)</option>
                            <option value="SBI">State Bank of India</option>
                            <option value="HDFC">HDFC Bank</option>
                            <option value="ICICI">ICICI Bank</option>
                            <option value="AXIS">Axis Bank</option>
                            <option value="PNB">Punjab National Bank</option>
                            <option value="OTHER">Other Bank</option>
                        </select>
                    </div>
                    <button class="wallet-btn" id="withdraw-btn" onclick="handleWithdraw()">Withdraw Now</button>
                    <p style="font-size: 0.8em; color: #666; margin-top: 10px; text-align: center;">*Min. Withdrawal Limit: ‚Çπ100</p>
                </div>

                <div class="wallet-section" id="history-section">
                    <h3>Deposit History</h3>
                    <div id="deposit-history-container">
                        <p style="text-align: center; color: #666;">Loading your history...</p>
                    </div>
                    </div>
            </div>
        </div>
        
        <div class="share-modal" id="share-modal">
            <div class="share-content">
                <button class="close-btn" onclick="closeShareModal()">&times;</button>
                <h3>Share with Friends</h3>
                <p>Invite friends and earn <span id="referral-amount-display">‚Çπ50</span> for each referral!</p>
                
                <div class="share-options">
                    <div class="share-option" onclick="shareViaWhatsApp()">
                        <div class="share-icon whatsapp">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <span>WhatsApp</span>
                    </div>
                    
                    <div class="share-option" onclick="shareViaFacebook()">
                        <div class="share-icon facebook">
                            <i class="fab fa-facebook"></i>
                        </div>
                        <span>Facebook</span>
                    </div>
                    
                    <div class="share-option" onclick="shareViaTelegram()">
                        <div class="share-icon telegram">
                            <i class="fab fa-telegram"></i>
                        </div>
                        <span>Telegram</span>
                    </div>
                    
                    <div class="share-option" onclick="shareViaSMS()">
                        <div class="share-icon sms">
                            <i class="fas fa-sms"></i>
                        </div>
                        <span>SMS</span>
                    </div>
                    
                    <div class="share-option" onclick="shareViaEmail()">
                        <div class="share-icon email">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <span>Email</span>
                    </div>
                    
                    <div class="share-option" onclick="copyReferralLink()">
                        <div class="share-icon copy">
                            <i class="fas fa-copy"></i>
                        </div>
                        <span>Copy Link</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="overlay" id="overlay"></div>
        
        <div id="home-content">
            <div class="slider">
                <div class="slides" id="slides">
                    <div class="slide" style="background-color: #f0f0f0;">Loading Slides...</div>
                </div>
            </div>
            
            <div class="english-course-card">
                <h3>PREMIUM ENGLISH COURSE</h3>
                <p>Unlock your potential! Advanced Spoken English Course.</p>
                <h4 id="course-fee-display" style="color: #ffeb3b; margin-bottom: 10px;">Course Fee: Loading...</h4>
                <button class="course-purchase-btn" id="course-purchase-btn" onclick="handleCoursePurchase()">
                    Purchase Now
                </button>
            </div>

            <div class="english-course-service-card" onclick="showEnglishCourse()">
                 <i class="fas fa-book-open"></i>
                 <h4>Access English Course</h4>
            </div>
            
            <div class="services" style="display: none;">
                </div>
            
            <div class="invite-card">
                <h3>Invite & Earn</h3>
                <p>Invite your friends and earn <span id="referral-amount-display-2">‚Çπ50</span> for each successful referral!</p>
                <button class="invite-btn" onclick="showShareModal()">Invite Now</button>
            </div>
            
            <div class="contest-section">
                <h2>Active Contests</h2>
                <div id="contests-container">
                    <p style="text-align: center;">Loading contests...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="my-contests-page">
        <div class="contest-section">
            <h2 style="text-align: center; color: #007bff; margin-bottom: 20px; padding-top: 15px;">‚≠ê My Contests (Joined & Past)</h2>
            <div id="joined-contests-container">
                <p style="text-align: center; color: #999; margin-top: 10px; font-size: 0.85rem;">Loading your joined contests...</p>
            </div>
        </div>
    </div>
    
    <div id="leaderboard-page">
        <div class="contest-section">
            <h2 style="text-align: center; color: #ff0000; margin-bottom: 20px; padding-top: 15px;">üèÜ Global Leaderboard (Top Scorers)</h2>
            <div id="leaderboard-container">
                <p style="text-align: center; color: #666;">Loading leaderboard data...</p>
            </div>
        </div>
    </div>

    <div id="english-course-page">
        <h2 style="color: #007bff; text-align: center; margin-bottom: 20px;">English Speaking Course</h2>
        <div id="course-content-placeholder">
            <p>Your English course content goes here.</p>
            <p style="font-weight: bold; color: #28a745;">Since you have purchased and been verified, you can now access the lessons.</p>
            <p>If you have a separate `english-course.html` file, you need to integrate its content or redirect here.</p>
            <button class="wallet-btn" onclick="showHome()" style="margin-top: 20px;">Back to Home</button>
        </div>
    </div>
    
    <div id="quiz-page">
        <div class="quiz-header">
            <div class="question-count">Question <span id="current-q">1</span>/<span id="total-qs">19</span></div>
            <div class="timer" id="quiz-timer">06</div>
        </div>
        
        <div class="question-container">
            <div class="question-number">Question <span id="q-number">1</span></div>
            <div class="question-text" id="question-text">Loading question...</div>
            <div class="options" id="options-container">
                </div>
        </div>
        
        <button class="next-btn" id="next-btn">Next Question</button>
    </div>
    
    <div class="results-popup" id="results-popup">
        <div class="popup-content">
            <h2>Quiz Submitted!</h2>
            <p>Your answers have been submitted successfully. Results will be announced on <span id="result-date"></span>.</p>
            <button class="popup-btn" onclick="closeResults()">OK</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showHome(); setActiveNav(this);">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="showActiveContests(); setActiveNav(this);">
            <i class="fas fa-trophy"></i>
            <span>Contests</span>
        </div>
        <div class="nav-item" onclick="showMyContests(); setActiveNav(this);">
            <i class="fas fa-check-square"></i>
            <span>My Contests</span>
        </div>
        <div class="nav-item" onclick="showLeaderboard(); setActiveNav(this);">
            <i class="fas fa-ranking-star"></i>
            <span>Leaderboard</span>
        </div>
    </div>


    <script>
        // Firebase Configuration (Aapka diya hua)
        const firebaseConfig = {
            apiKey: "AIzaSyBAfmc3i3AT0YDR9DprPb9m1x8xvqT6Cn8",
            authDomain: "iqlevale.firebaseapp.com",
            databaseURL: "https://iqlevale-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "iqlevale",
            storageBucket: "iqlevale.firebasestorage.app",
            messagingSenderId: "313766803659",
            appId: "1:313766803659:web:381f8588450a91f2c7834e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // --- BASE PATH DEFINITION ---
        const BASE_DB_PATH = "dreem15_data/";
        
        // Helper function to get database reference with the base path
        function getDBRef(path) {
            return database.ref(BASE_DB_PATH + path); 
        }

        // DOM Elements
        const splashScreen = document.getElementById('splash-screen');
        const authPage = document.getElementById('auth-page');
        const homePage = document.getElementById('home-page');
        const homeContent = document.getElementById('home-content');
        const profilePage = document.getElementById('profile-page');
        const quizPage = document.getElementById('quiz-page');
        
        // NEW DOM: Leaderboard, My Contests and English Course
        const leaderboardPage = document.getElementById('leaderboard-page');
        const myContestsPage = document.getElementById('my-contests-page');
        const englishCoursePage = document.getElementById('english-course-page'); // NEW
        const joinedContestsContainer = document.getElementById('joined-contests-container'); 
        const bottomNavItems = document.querySelectorAll('.nav-item');

        // Buttons for Loading States
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const submitUtrBtn = document.getElementById('submit-utr-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const openRazorpayBtn = document.getElementById('open-razorpay-btn'); 

        // Current user data
        let userData = null; // User profile data
        let contestsData = {}; // Store all contests data
        let sliderInterval;
        let contestTimers = {}; 
        
        // ‚≠ê GLOBAL LOCK: Prevents repeated clicks/joins
        let isJoiningContest = false; 

        // --- ADMIN SETTINGS VARIABLES (Will be updated by loadSettings) ---
        let referralBonus = 50; // Default 50 INR 
        let courseFee = 2200; // Default Fee (Updated from 1999 to 2200 for initial load consistency)
        const RAZORPAY_LINK = "https://razorpay.me/@shinexcoin"; // Replace with your actual Razorpay link
        const APP_DOWNLOAD_LINK = "https://play.google.com/store/apps/details?id=com.example.dreem15"; 
        const ADMIN_EMAIL = "sk12shaikh@gmail.com"; 

        // ‚úÖ‚úÖ‚úÖ FIX: URL hash check for direct home page access
        // App Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // URL hash check karein - agar #home hai to direct home page show karein
            if (window.location.hash === '#home') {
                history.replaceState(null, null, ' ');
            }
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    
                    // ADMIN REDIRECTION LOGIC
                    if (user.email === ADMIN_EMAIL) {
                        console.log("Admin Logged In. Redirecting to admin.html");
                        // NOTE: Assuming 'admin.html' exists in your setup
                        window.location.href = 'admin.html';
                        return; 
                    } 
                    
                    // User Logged In (Not Admin)
                    // ‚≠ê FIX: Load user data first, then handle UI/contests ‚≠ê
                    loadUserData(user); 
                    
                    // UI Display: User ko home-page (index.html) par rakhna
                    splashScreen.style.display = 'none';
                    authPage.style.display = 'none';
                    homePage.style.display = 'block';
                    showHome(); // Initial transition to home, further updates in loadUserData
                    
                } else {
                    userData = null;
                    updateProfile(); 
                    
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                        authPage.style.display = 'flex';
                    }, 3000);
                }
            });
            
            initializeApp();
        });
        
        function initializeApp() {
            setupEventListeners();
            loadSettings(); 
            loadSliders(); 
            loadContests(); // Load contests data once
            // NEW: Start the contest timer update loop
            setInterval(updateContestTimers, 1000);
        }
        
        function loadSettings() {
            getDBRef('settings').once('value', (snapshot) => {
                const settings = snapshot.val();
                
                if (settings) {
                    referralBonus = settings.referralBonus || 50;
                    const bonusText = `‚Çπ${referralBonus}`;
                    document.getElementById('referral-amount-display').textContent = bonusText;
                    document.getElementById('referral-amount-display-2').textContent = bonusText;
                    
                    // ‚≠ê ISSUE 1 FIX APPLIED HERE: Load Course Fee from the correct Firebase node 'premiumCourseFee' ‚≠ê
                    courseFee = settings.premiumCourseFee || 2200;
                    document.getElementById('course-fee-display').textContent = `Course Fee: ‚Çπ${courseFee.toFixed(2)}/-`;

                } else {
                     // If no settings, use default fee
                     document.getElementById('course-fee-display').textContent = `Course Fee: ‚Çπ${courseFee.toFixed(2)}/-`;
                }
            }, (error) => { 
                console.error("Error loading settings:", error.message);
                 document.getElementById('course-fee-display').textContent = `Course Fee: ‚Çπ${courseFee.toFixed(2)}/-`;
            });
        }
        
        function loadSliders() {
            const slidesContainer = document.getElementById('slides');
            slidesContainer.innerHTML = '<div class="slide" style="background-color: #f0f0f0;">Loading Slides...</div>';
            
            getDBRef('sliders').once('value', (snapshot) => {
                const sliders = snapshot.val();
                let html = '';
                
                clearInterval(sliderInterval); 

                if (sliders) {
                    
                    Object.entries(sliders).forEach(([key, slide]) => {
                        const imageUrl = slide.imageUrl || ''; 
                        const text = slide.text || 'New Offer!';
                        
                        const backgroundStyle = imageUrl ? `background-image: url('${imageUrl}');` : `background-color: #e3f2fd;`;

                        html += `
                            <div class="slide" style="${backgroundStyle}">
                                ${imageUrl ? '' : `<h2 style="padding: 10px; background: rgba(255,255,255,0.8); border-radius: 5px;">${text}</h2>`}
                            </div>
                        `;
                    });

                    slidesContainer.innerHTML = html;
                    
                    const totalSlides = Object.keys(sliders).length;
                    if (totalSlides > 1) {
                        let slideIndex = 0;
                        slidesContainer.dataset.current = 0;

                        sliderInterval = setInterval(() => {
                            slideIndex = (slideIndex + 1) % totalSlides;
                            slidesContainer.style.transform = `translateX(-${slideIndex * 100}%)`;
                            slidesContainer.dataset.current = slideIndex;
                        }, 4000);
                    }
                } else {
                    slidesContainer.innerHTML = '<div class="slide" style="background-color: #e3f2fd;">Welcome to Dreem15!</div>';
                    clearInterval(sliderInterval);
                }
            }, (error) => { 
                console.error("Error loading sliders:", error.message);
                slidesContainer.innerHTML = '<div class="slide" style="background-color: #fce4e4; color: red;">Error loading slides.</div>';
            });
        }

        function setupEventListeners() {
            // Auth Tabs
            document.getElementById('login-tab').addEventListener('click', () => {
                document.getElementById('login-tab').classList.add('active');
                document.getElementById('signup-tab').classList.remove('active');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
            });
            
            document.getElementById('signup-tab').addEventListener('click', () => {
                document.getElementById('signup-tab').classList.add('active');
                document.getElementById('login-tab').classList.remove('active');
                document.getElementById('signup-form').style.display = 'block';
                document.getElementById('login-form').style.display = 'none';
            });
            
            // Auth Buttons
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('signup-btn').addEventListener('click', handleSignup);
            
            // Menu/Overlay Toggles
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('side-menu').classList.toggle('active');
                document.getElementById('overlay').classList.toggle('active');
            });
            
            document.getElementById('wallet-icon').addEventListener('click', showWallet);
            
            document.getElementById('close-wallet').addEventListener('click', () => {
                document.getElementById('wallet-modal').style.display = 'none';
            });
            
            // Wallet Tabs Logic 
            document.getElementById('deposit-tab').addEventListener('click', () => {
                document.getElementById('deposit-tab').classList.add('active');
                document.getElementById('withdraw-tab').classList.remove('active');
                document.getElementById('history-tab').classList.remove('active');
                document.getElementById('deposit-section').classList.add('active');
                document.getElementById('withdraw-section').classList.remove('active');
                document.getElementById('history-section').classList.remove('active');
            });
            
            document.getElementById('withdraw-tab').addEventListener('click', () => {
                document.getElementById('withdraw-tab').classList.add('active');
                document.getElementById('deposit-tab').classList.remove('active');
                document.getElementById('history-tab').classList.remove('active');
                document.getElementById('withdraw-section').classList.add('active');
                document.getElementById('deposit-section').classList.remove('active');
                document.getElementById('history-section').classList.remove('active');
            });

            document.getElementById('history-tab').addEventListener('click', () => {
                document.getElementById('history-tab').classList.add('active');
                document.getElementById('withdraw-tab').classList.remove('active');
                document.getElementById('deposit-tab').classList.remove('active');
                document.getElementById('history-section').classList.add('active');
                document.getElementById('deposit-section').style.display = 'none';
                document.getElementById('withdraw-section').style.display = 'none';
                loadDepositHistory(); 
            });
            // End Wallet Tabs Logic

            document.getElementById('overlay').addEventListener('click', () => {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('wallet-modal').style.display = 'none';
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('terms-modal').style.display = 'none'; // NEW
                document.getElementById('overlay').classList.remove('active');
            });
            
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
        }

        // ‚≠ê loadUserData: Reloads profile data and updates UI/Contests ‚≠ê
        function loadUserData(user) {
            if (!user) {
                userData = null;
                return;
            }
            
            // Use 'on' for continuous updates (e.g., balance change)
            getDBRef('users/' + user.uid).on('value', (snapshot) => {
                const fetchedData = snapshot.val();
                
                if (!fetchedData) {
                    console.warn("User data not found in database. Prompting creation...");
                    return; 
                }
                
                userData = fetchedData; 
                
                // Update UI elements dependent on user data
                const currentWalletBalance = userData.walletBalance || 0;
                document.getElementById('wallet-balance-amount').textContent = `‚Çπ${currentWalletBalance.toFixed(2)}`;
                
                updateProfile(); 
                // ‚≠ê CRITICAL FIX: Reload contests with 'checkJoined=true' after user data is guaranteed to be loaded
                loadContests(true); 

            }, (error) => {
                console.error("Error fetching user data:", error.message);
            });
        }
        
        // --- UPDATED Navigation Functions ---
        function hideAllPages() {
            homeContent.style.display = 'none';
            profilePage.style.display = 'none';
            quizPage.style.display = 'none'; 
            leaderboardPage.style.display = 'none';
            myContestsPage.style.display = 'none'; 
            englishCoursePage.style.display = 'none'; // NEW: Hide English Course Page
            document.getElementById('side-menu').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('terms-modal').style.display = 'none'; 
        }

        function setActiveNav(element) {
             bottomNavItems.forEach(item => item.classList.remove('active'));
             // The English Course page does not use the bottom nav, so we only activate if the element is from the bottom nav
             if(element && element.classList.contains('nav-item')) {
                 element.classList.add('active');
             }
        }

        function showHome() {
            hideAllPages();
            homeContent.style.display = 'block';
            setActiveNav(document.querySelector('.nav-item:nth-child(1)'));
            
            // ‚úÖ‚úÖ‚úÖ FIX: URL se hash remove karenge
            if (window.location.hash) {
                history.replaceState(null, null, ' ');
            }
        }
        
        function showActiveContests() {
            showHome();
            setTimeout(() => {
                const contestSection = document.querySelector('.contest-section:last-of-type'); 
                if (contestSection) {
                    contestSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100); 
            setActiveNav(document.querySelector('.nav-item:nth-child(2)'));
        }
        
        function showMyContests() {
            if (!firebase.auth().currentUser) {
                alert("‡§Ö‡§™‡§®‡•á ‡§ú‡•â‡§á‡§® ‡§ï‡§ø‡§è ‡§ó‡§è ‡§ï‡•â‡§®‡•ç‡§ü‡•á‡§∏‡•ç‡§ü ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§π‡§≤‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç‡•§");
                return;
            }
            hideAllPages();
            myContestsPage.style.display = 'block';
            loadMyContestsData(); 
            setActiveNav(document.querySelector('.nav-item:nth-child(3)'));
        }

        function showProfile() {
            hideAllPages();
            updateProfile(); 
            profilePage.style.display = 'block';
        }

        // NEW FUNCTION: Show English Course Page (Logic based on purchase status)
        function showEnglishCourse() {
             if (!firebase.auth().currentUser || !userData) {
                alert("Kripya pehle login karein‡•§");
                return;
             }
             
             const isPurchased = userData.isCoursePurchased || false;

             if (!isPurchased) {
                alert("Kripya pehle course purchase karein aur Admin Verification ka intezaar karein‡•§");
                showHome(); // Stay on Home page to prompt purchase
                return;
             }
             
             // If purchased, proceed to the course content
             hideAllPages();
             englishCoursePage.style.display = 'block';
             // Placeholder: loadCourseContent(); 
        }

        function showWallet() {
            document.getElementById('wallet-modal').style.display = 'flex';
            document.getElementById('side-menu').classList.remove('active');
            document.getElementById('overlay').classList.add('active'); // Added overlay activation
            document.getElementById('deposit-tab').click(); 
        }

        function showTermsModal() {
             document.getElementById('terms-modal').style.display = 'flex';
             document.getElementById('side-menu').classList.remove('active');
             document.getElementById('overlay').classList.add('active');
        }

        function closeTermsModal() {
            document.getElementById('terms-modal').style.display = 'none';
            document.getElementById('overlay').classList.remove('active');
        }
        
        function showLeaderboard() {
            if (!firebase.auth().currentUser) {
                alert("‡§≤‡•Ä‡§°‡§∞‡§¨‡•ã‡§∞‡•ç‡§° ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§π‡§≤‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç‡•§");
                return;
            }
            hideAllPages();
            leaderboardPage.style.display = 'block';
            loadLeaderboard();
            setActiveNav(document.querySelector('.nav-item:nth-child(4)'));
        }
        // --- END UPDATED Navigation Functions ---
        
        function updateProfile() {
             const user = firebase.auth().currentUser;
             if (!userData || !user) {
                document.getElementById('profile-name').textContent = 'Guest User';
                document.getElementById('profile-email').textContent = 'Please log in.';
                document.getElementById('profile-referral').textContent = 'N/A';
                document.getElementById('profile-joined').textContent = 'N/A';
                document.getElementById('profile-referrals').textContent = '0';
                document.getElementById('course-status').textContent = 'Locked';
                document.getElementById('course-status').style.color = '#ff0000';
                return;
             }
             document.getElementById('profile-name').textContent = userData.name || user.email;
             document.getElementById('profile-email').textContent = user.email;
             document.getElementById('profile-referral').textContent = userData.referralCode || 'N/A';
             document.getElementById('profile-joined').textContent = new Date(userData.joinedDate).toLocaleDateString();
             
             const courseStatusEl = document.getElementById('course-status');
             const purchaseBtn = document.getElementById('course-purchase-btn');

             if (userData.isCoursePurchased) {
                 courseStatusEl.textContent = 'Purchased & Unlocked';
                 courseStatusEl.style.color = '#28a745';
                 purchaseBtn.textContent = 'Course Unlocked';
                 purchaseBtn.disabled = true;
                 purchaseBtn.style.background = '#28a745'; // Green background for unlocked button
             } else {
                 // Check if a PENDING deposit request for course fee exists (optimistic lock)
                 getDBRef('depositRequests').orderByChild('userId').equalTo(user.uid).once('value', (snapshot) => {
                    let isPending = false;
                    snapshot.forEach(req => {
                        const reqData = req.val();
                        // IMPORTANT: Check for exact amount match with current courseFee AND purpose
                        // Used loose equality (==) for robust checking in case of number/string mix
                        if (reqData.purpose === 'English Course Purchase' && reqData.status === 'Pending' && reqData.amount == courseFee) { 
                            isPending = true;
                        }
                    });
                    
                    if (isPending) {
                        courseStatusEl.textContent = 'Payment Pending Admin Check';
                        courseStatusEl.style.color = '#ffc107'; // Yellow/Orange
                        purchaseBtn.textContent = 'Verification Pending';
                        purchaseBtn.disabled = true;
                        purchaseBtn.style.background = '#ffc107'; // Yellow/Orange background
                    } else {
                        courseStatusEl.textContent = 'Purchase Now';
                        courseStatusEl.style.color = '#ff0000';
                        purchaseBtn.textContent = 'Purchase Now';
                        purchaseBtn.disabled = false;
                        purchaseBtn.style.background = '#4CAF50'; // Green background 
                    }
                 });
             }

             // Placeholder: Check Referrals count
             getDBRef('referrals').orderByChild('referrerId').equalTo(user.uid).once('value', (snapshot) => {
                 const count = snapshot.exists() ? snapshot.numChildren() : 0;
                 document.getElementById('profile-referrals').textContent = count;
             });
        }

        function showShareModal() {
            document.getElementById('share-modal').style.display = 'flex';
            document.getElementById('side-menu').classList.remove('active');
            document.getElementById('overlay').classList.add('active'); 
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
            document.getElementById('overlay').classList.remove('active'); 
        }
        
        // Placeholder Login/Signup/Logout functions (IMPLEMENTATION REQUIRED)
        function handleLogin() { 
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                alert("Please enter email and password.");
                return;
            }
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Success, auth.onAuthStateChanged will handle UI/data load
                })
                .catch((error) => {
                    alert(`Login Failed: ${error.message}`);
                    loginBtn.textContent = 'Login';
                    loginBtn.disabled = false;
                });
        }

        function handleSignup() { 
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const referralCode = document.getElementById('signup-referral-code').value;

            if (!name || !email || !password) {
                alert("Please fill in all required fields (Name, Email, Password).");
                return;
            }

            signupBtn.textContent = 'Signing up...';
            signupBtn.disabled = true;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Generate Unique Referral Code
                    const namePart = name.substring(0, 3).toUpperCase();
                    const numPart = Math.floor(100 + Math.random() * 900); 
                    const uniqueReferralCode = namePart + numPart;
                    
                    // Create User Profile in Realtime DB
                    const userDataToSave = {
                        name: name,
                        email: email,
                        walletBalance: 0,
                        joinedDate: new Date().toISOString(),
                        isCoursePurchased: false,
                        isAdmin: false,
                        referralCode: uniqueReferralCode
                    };

                    getDBRef('users/' + user.uid).set(userDataToSave)
                        .then(() => {
                            // Handle Referral Logic (if code was provided)
                            if (referralCode) {
                                handleReferral(referralCode, user.uid);
                            }
                            // loadUserData will be called by auth.onAuthStateChanged
                        });
                })
                .catch((error) => {
                    alert(`Sign Up Failed: ${error.message}`);
                    signupBtn.textContent = 'Sign Up';
                    signupBtn.disabled = false;
                });
        }

        function handleReferral(referrerCode, newUserId) {
            getDBRef('users').orderByChild('referralCode').equalTo(referrerCode).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const referrerKey = Object.keys(snapshot.val())[0];
                    const referrerData = snapshot.val()[referrerKey];
                    const referrerId = referrerKey;

                    // 1. Give bonus to the Referrer
                    const bonus = referralBonus;
                    const newBalance = (referrerData.walletBalance || 0) + bonus;

                    getDBRef('users/' + referrerId + '/walletBalance').set(newBalance);
                    
                    // 2. Log the referral
                    getDBRef('referrals').push().set({
                        referrerId: referrerId,
                        referredUserId: newUserId,
                        bonusAmount: bonus,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    console.log(`Referral bonus of ‚Çπ${bonus} credited to referrer.`);
                }
            });
        }


        function handleLogout() {
            // Stop listening to user data updates on logout
            if (firebase.auth().currentUser) {
                getDBRef('users/' + firebase.auth().currentUser.uid).off('value');
            }
            auth.signOut().catch((error) => {
                console.error('Logout error:', error);
            });
        }
        
        // Helper to format remaining time
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const days = Math.floor(totalSeconds / (3600 * 24));
            const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (days > 0) {
                 return `${days} ‡§¶‡§ø‡§® ${hours} ‡§ò‡§Ç‡§ü‡•á`;
            } else if (hours > 0) {
                 return `${hours} ‡§ò‡§Ç‡§ü‡•á ${minutes} ‡§Æ‡§ø‡§®‡§ü`;
            } else if (minutes > 0) {
                 return `${minutes} ‡§Æ‡§ø‡§®‡§ü ${seconds} ‡§∏‡•á‡§ï‡§Ç‡§°`;
            } else {
                 return `${seconds} ‡§∏‡•á‡§ï‡§Ç‡§°`;
            }
        }
        
        // Function to update all active contest timers (called every 1s)
        function updateContestTimers() {
            const now = Date.now();
            
            Object.entries(contestsData).forEach(([id, contest]) => {
                const timerEl = document.getElementById(`timer-${id}`);
                const drawDateEl = document.getElementById(`draw-date-${id}`);

                if (timerEl && contest.drawTime) {
                    const drawTime = new Date(contest.drawTime).getTime();
                    const timeLeft = drawTime - now;

                    if (timeLeft > 0) {
                        timerEl.textContent = formatTime(timeLeft);
                        // Update draw date in card too
                        if(drawDateEl) {
                           drawDateEl.textContent = `üóìÔ∏è ${new Date(contest.drawTime).toLocaleString('en-IN', { 
                               year: 'numeric',
                               month: 'short', 
                               day: 'numeric', 
                               hour: '2-digit', 
                               minute: '2-digit',
                               hour12: true 
                           })}`;
                        }

                    } else {
                        timerEl.textContent = '‡§∏‡§Æ‡§æ‡§™‡•ç‡§§';
                        timerEl.style.backgroundColor = '#dc3545'; // Red for ended
                        if(drawDateEl) {
                           drawDateEl.textContent = '‚è≥ Result Pending';
                           drawDateEl.style.color = '#dc3545';
                        }
                        // Disable join button if contest has ended
                        const joinBtn = document.querySelector(`.contest-card button[onclick*="'${id}'"]`);
                        if(joinBtn && !joinBtn.classList.contains('already-joined')) {
                             joinBtn.textContent = 'Contest Ended';
                             joinBtn.disabled = true;
                        }
                    }
                }
            });
        }
        
        // ‚≠ê UPDATED loadContests FUNCTION - Fixed Contest Join Logic
        function loadContests(checkJoined = false) { 
            const container = document.getElementById('contests-container');
            if(Object.keys(contestsData).length === 0) {
                 container.innerHTML = '<p style="text-align: center;">Loading contests...</p>';
            }
            
            getDBRef('contests').once('value', (snapshot) => {
                const contests = snapshot.val();
                contestsData = contests || {};
                let html = '';
                
                if (contests) {
                    Object.entries(contests).forEach(([id, contest]) => {
                        // ‚≠ê FIXED: Proper join check - user ek hi baar join kar sake
                        const isJoined = userData && userData.joinedContests && userData.joinedContests[id];
                        const buttonText = isJoined ? 'Already Joined' : 'Join Contest';
                        const buttonClass = isJoined ? 'join-btn already-joined' : 'join-btn';
                        // Check if contest has ended
                        const isEnded = contest.drawTime && (new Date(contest.drawTime).getTime() <= Date.now());
                        const isDisabled = isJoined || isEnded ? 'disabled' : '';
                        
                        // ‚≠ê Firebase structure ke according fields use kar rahe hain
                        const feeDisplay = `<span class="contest-fee-amount" style="color: #28a745; font-weight: bold;">FREE</span>`;

                        // 3. Contest Details for Card (Firebase structure ke according)
                        const contestImageURL = contest.image || '';
                        const totalSlots = contest.spots || 0; // Firebase mein 'spots' field hai
                        const slotsFilled = contest.spots_filled || 0; // Firebase mein 'spots_filled' field hai
                        const progressPercentage = totalSlots > 0 ? (slotsFilled / totalSlots) * 100 : 0;
                        const remainingSlots = totalSlots - slotsFilled;
                        const firstPrize = contest.firstPrize || 0;
                        const prizePool = contest.prize || 0; // Firebase mein 'prize' field hai
                        
                        // Format Draw Date
                        let drawDateTimeDisplay = 'N/A';
                        if (contest.drawTime) {
                           try {
                                const drawDate = new Date(contest.drawTime);
                                drawDateTimeDisplay = drawDate.toLocaleString('en-IN', { 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    hour12: true 
                                });
                           } catch (e) {
                               console.error("Invalid drawTime format:", contest.drawTime);
                           }
                        }
                        
                        // 4. Prize Structure Display
                        let prizeStructureHTML = '';
                        if (contest.prizeStructure && Object.keys(contest.prizeStructure).length > 0) {
                            prizeStructureHTML = `
                                <div class="prize-structure">
                                    <h4>üèÜ Prize Distribution</h4>
                                    ${Object.keys(contest.prizeStructure)
                                        .sort((a, b) => parseInt(a) - parseInt(b))
                                        .slice(0, 5) // Show only first 5 ranks
                                        .map(rank => `
                                            <div class="prize-rank">
                                                <span class="prize-rank-number">Rank ${rank}</span>
                                                <span class="prize-rank-amount">‚Çπ${parseInt(contest.prizeStructure[rank]).toLocaleString('en-IN')}</span>
                                            </div>
                                        `).join('')}
                                    ${Object.keys(contest.prizeStructure).length > 5 ? 
                                        `<div style="text-align: center; margin-top: 5px; font-size: 0.8rem; color: #666;">
                                            + ${Object.keys(contest.prizeStructure).length - 5} more ranks...
                                        </div>` : ''}
                                </div>
                            `;
                        }
                        
                        // 5. HTML Structure for Card - Updated with proper spots display and prize structure
                        html += `
                            <div class="contest-card">
                                <div class="contest-header">
                                    <h3 style="color: #28a745; margin: 0; font-size: 1.3rem; font-weight: bold;">${contest.name || 'New Contest'}</h3>
                                    <div class="contest-timer-details">
                                        <span class="contest-timer" id="timer-${id}">${isEnded ? 'Ended' : 'Loading...'}</span>
                                        <span class="draw-date" id="draw-date-${id}" style="color: ${isEnded ? '#dc3545' : '#007bff'};">${isEnded ? 'Result Pending' : drawDateTimeDisplay}</span>
                                    </div>
                                </div>
                                <div class="contest-image" style="background-image: url('${contestImageURL}')"> 
                                    ${contestImageURL ? '' : 'Image Placeholder'}
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                   <div style="display: flex; justify-content: space-between; font-size: 1rem; font-weight: 500;">
                                       <span>üí∞ Total Prize: </span>
                                       <span class="contest-prize">‚Çπ${prizePool.toLocaleString('en-IN')}</span>
                                   </div>
                                   <div style="display: flex; justify-content: space-between; font-size: 1.1rem; margin-top: 8px;">
                                       <span style="color: #28a745; font-weight: bold;">ü•á 1st Prize:</span>
                                       <span class="contest-first-prize">${firstPrize}</span>
                                   </div>
                                   <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 5px;">
                                       <span style="color: #555;">üë• Total Spots:</span>
                                       <span style="font-weight: bold; color: #333;">${totalSlots}</span>
                                   </div>
                                   <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 5px;">
                                       <span style="color: #555;">‚úÖ Filled:</span>
                                       <span style="font-weight: bold; color: #333;">${slotsFilled}</span>
                                   </div>
                                   <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 5px;">
                                       <span style="color: #555;">üéØ Available:</span>
                                       <span style="font-weight: bold; color: #28a745;">${remainingSlots}</span>
                                   </div>
                                </div>

                                ${prizeStructureHTML}

                                <div class="progress-bar" title="${remainingSlots} slots remaining">
                                    <div class="progress" style="width: ${progressPercentage}%;"></div>
                                </div>
                                
                                <div class="contest-fee">
                                    <span class="contest-fee-label">Entry Fee:</span>
                                    ${feeDisplay} 
                                </div>
                                
                                <button class="${buttonClass}" ${isDisabled} onclick="startQuiz(event, '${id}', '${contest.name}')">${isEnded ? 'Contest Ended' : buttonText}</button>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                    // Initial update of timers after loading contests
                    updateContestTimers(); 
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No active contests currently.</p>';
                }
            }, (error) => {
                console.error("Error loading contests:", error.message);
                container.innerHTML = '<p style="text-align: center; color: red;">Error loading contests.</p>';
            });
        }
        
        function openRazorpayLink() {
            if (RAZORPAY_LINK) {
                 window.open(RAZORPAY_LINK, '_blank');
            } else {
                alert("ERROR: Razorpay Link not configured.");
            }
        }
        
        // UPDATED submitDepositUTR (Handles Issue 1 logic)
        function submitDepositUTR() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const utr = document.getElementById('deposit-utr').value.trim();
            const user = firebase.auth().currentUser;

            if (!user) {
                alert("Login required.");
                return;
            }

            if (isNaN(amount) || amount <= 0) {
                alert("Please enter a valid amount (‚Çπ).");
                return;
            }

            if (utr.length < 10) {
                alert("Please enter a valid Transaction/UTR ID (Min. 10 digits).");
                return;
            }

            // Check if this UTR is already submitted
            getDBRef('depositRequests').orderByChild('utr').equalTo(utr).once('value', (snapshot) => {
                let existingRequest = null;
                snapshot.forEach(req => {
                    if(req.val().utr === utr) {
                        existingRequest = req.val();
                    }
                });

                if (existingRequest) {
                    alert(`This UTR has already been submitted and is currently ${existingRequest.status}. Please wait for verification.`);
                    return;
                }

                // Determine the purpose (Deposit or Course Purchase)
                // Use the globally updated 'courseFee'
                const isCoursePurchase = (amount == courseFee && !(userData.isCoursePurchased || false));
                const purpose = isCoursePurchase ? 'English Course Purchase' : 'Wallet Deposit';
                const status = 'Pending';
                
                submitUtrBtn.textContent = 'Submitting...';
                submitUtrBtn.disabled = true;

                // Submit the request to the database
                getDBRef('depositRequests').push().set({
                    userId: user.uid,
                    userName: userData.name || user.email,
                    amount: amount,
                    utr: utr,
                    purpose: purpose, // Added purpose field
                    status: status,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    alert(`Successfully submitted UTR for ${purpose} (‚Çπ${amount.toFixed(2)}). Admin will verify soon.`);
                    document.getElementById('deposit-amount').value = '';
                    document.getElementById('deposit-utr').value = '';
                    loadDepositHistory(); // Reload wallet history
                    updateProfile(); // Re-check course status for optimistic lock (Pending)
                }).catch(error => {
                    alert(`Submission failed: ${error.message}`);
                }).finally(() => {
                    submitUtrBtn.textContent = 'Submit UTR for Verification';
                    submitUtrBtn.disabled = false;
                });
            });
        }
        
        // ‚≠ê FIXED: Complete Withdrawal Logic Implementation with IMMEDIATE balance deduction
        function handleWithdraw() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const name = document.getElementById('withdraw-name').value.trim();
            const upi = document.getElementById('withdraw-upi').value.trim();
            const account = document.getElementById('withdraw-account').value.trim();
            const ifsc = document.getElementById('withdraw-ifsc').value.trim();
            const bank = document.getElementById('withdraw-bank').value;
            const user = firebase.auth().currentUser;

            if (!user) {
                alert("Withdrawal ke liye login karein.");
                return;
            }

            // Validation checks
            if (isNaN(amount) || amount <= 0) {
                alert("Please enter a valid withdrawal amount.");
                return;
            }

            // Minimum withdrawal check - ‚Çπ100
            if (amount < 100) {
                alert("Minimum withdrawal limit ‚Çπ100 hai.");
                return;
            }

            // Balance check
            const currentBalance = userData.walletBalance || 0;
            if (amount > currentBalance) {
                alert(`Insufficient balance! Aapke paas sirf ‚Çπ${currentBalance.toFixed(2)} hain.`);
                return;
            }

            // Either UPI or Bank details should be provided
            if (!upi && (!account || !ifsc)) {
                alert("Kripya ya toh UPI ID bharein ya Bank Account details (Account No aur IFSC Code).");
                return;
            }

            if (!name) {
                alert("Kripya apna full name enter karein.");
                return;
            }

            // UI Feedback
            const withdrawBtn = document.getElementById('withdraw-btn');
            const originalText = withdrawBtn.textContent;
            withdrawBtn.textContent = 'Processing...';
            withdrawBtn.disabled = true;

            // ‚≠ê FIX: Pehle balance deduct karo, phir request create karo
            const userRef = getDBRef('users/' + user.uid);
            
            // 1. Pehle balance deduct karo
            userRef.child('walletBalance').transaction(currentBalance => {
                const balance = currentBalance || 0;
                
                // Balance check karo
                if (balance < amount) {
                    throw new Error("Insufficient balance for withdrawal");
                }
                
                // Balance deduct karo
                return balance - amount;
            })
            .then(() => {
                // 2. Phir withdrawal request create karo
                return getDBRef('withdrawalRequests').push().set({
                    userId: user.uid,
                    userName: userData.name || user.email,
                    amount: amount,
                    recipientName: name,
                    upiId: upi || '',
                    bankAccount: account || '',
                    ifscCode: ifsc || '',
                    bankName: bank || '',
                    status: 'Pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            })
            .then(() => {
                alert(`Withdrawal request of ‚Çπ${amount.toFixed(2)} submitted successfully! Amount immediately deducted from your wallet. Admin verification ke baad amount aapko transfer kar diya jayega.`);
                
                // Clear form
                document.getElementById('withdraw-amount').value = '';
                document.getElementById('withdraw-name').value = '';
                document.getElementById('withdraw-upi').value = '';
                document.getElementById('withdraw-account').value = '';
                document.getElementById('withdraw-ifsc').value = '';
                document.getElementById('withdraw-bank').value = '';
                
                // ‚≠ê Balance immediately update dikhane ke liye
                // Real-time listener automatically update kar dega, but temporary update for immediate feedback
                userData.walletBalance = (userData.walletBalance || 0) - amount;
                document.getElementById('wallet-balance-amount').textContent = `‚Çπ${userData.walletBalance.toFixed(2)}`;
                
            }).catch(error => {
                alert(`Withdrawal failed: ${error.message}`);
            }).finally(() => {
                withdrawBtn.textContent = originalText;
                withdrawBtn.disabled = false;
            });
        }

        function loadDepositHistory() { 
            const container = document.getElementById('deposit-history-container');
            const user = firebase.auth().currentUser;
            
            if (!user) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Please login to view history.</p>';
                return;
            }

            container.innerHTML = '<p style="text-align: center; color: #666;">Loading your history...</p>';

            getDBRef('depositRequests').orderByChild('userId').equalTo(user.uid).limitToLast(10).once('value', (snapshot) => {
                const requests = snapshot.val();
                let html = '';

                if (requests) {
                    const sortedRequests = Object.entries(requests)
                        .map(([key, value]) => ({ id: key, ...value }))
                        .sort((a, b) => b.timestamp - a.timestamp); // Sort by newest first

                    sortedRequests.forEach(req => {
                        const date = new Date(req.timestamp).toLocaleDateString();
                        const time = new Date(req.timestamp).toLocaleTimeString();
                        const amountText = `‚Çπ${(req.amount || 0).toFixed(2)}`;
                        const statusClass = req.status || 'Pending';

                        html += `
                            <div class="history-item ${statusClass}">
                                <div>
                                    <strong style="color: #333;">${req.purpose || 'Deposit'}</strong><br>
                                    <span style="font-size: 0.8em; color: #777;">UTR: ${req.utr}</span>
                                </div>
                                <div style="text-align: right;">
                                    <strong class="history-status" style="color: ${statusClass === 'Verified' ? '#28a745' : statusClass === 'Rejected' ? '#dc3545' : '#ffc107'};">${statusClass}</strong><br>
                                    <span style="font-weight: bold;">${amountText}</span>
                                    <p style="font-size: 0.7em; color: #999; margin: 0;">${date} ${time}</p>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html = '<p style="text-align: center; color: #666;">No deposit history found.</p>';
                }
                container.innerHTML = html;
            }, (error) => {
                console.error("Error loading deposit history:", error.message);
                container.innerHTML = '<p style="text-align: center; color: red;">Error loading history.</p>';
            });
        }


        // 1) Purchase Now button logic, 5) Purchase Flow Logic
        function handleCoursePurchase() {
            if (!firebase.auth().currentUser) {
                alert("Kripya pehle login karein‡•§");
                return;
            }
            
            if (userData && userData.isCoursePurchased) {
                alert("Aapne course pehle hi purchase kar liya hai‡•§ Course dekhne ke liye 'English Course' button par click karein‡•§");
                showEnglishCourse(); // Redirect to course page if already purchased
                return;
            }

            // Use the global courseFee variable (updated by loadSettings)
            const fee = courseFee || 2200; 
            const isConfirmed = confirm(`Aap Premium English Course (Fee: ‚Çπ${fee.toFixed(2)}) kharidne ja rahe hain‡•§ Payment ke liye Razorpay link naye tab mein khulegi‡•§ Payment karne ke baad, aapko UTR/Transaction ID submit karni hogi jiske verification ke baad hi course milega‡•§ Kya aap aage badhna chahte hain?`);

            if (isConfirmed) {
                // Step 1: Open payment link
                openRazorpayLinkForCourse();
                
                // Step 2: Show wallet modal with a pre-filled deposit amount for UTR submission
                setTimeout(() => {
                    showWallet(); 
                    // Pre-fill the exact course fee amount for correct UTR identification logic
                    document.getElementById('deposit-amount').value = fee.toFixed(2);
                    // Open deposit tab
                    document.getElementById('deposit-tab').click(); 
                    alert("Payment hone ke baad, kripya Payment Page par wapas aakar UTR/Transaction ID daalein aur 'Submit UTR for Verification' button dabayein‡•§");
                }, 500); 
            }
        }
        
        function openRazorpayLinkForCourse() {
            if (RAZORPAY_LINK) {
                 window.open(RAZORPAY_LINK, '_blank');
            } else {
                alert("ERROR: Razorpay Link not configured‡•§");
            }
        }

        // ‚≠ê UPDATED startQuiz FUNCTION - Fixed with proper flow and join check
        async function startQuiz(event, contestId, contestName) {
            // ‚≠ê 1. Global Lock Check 
            if (isJoiningContest) {
                console.log("Already processing a join request. Please wait.");
                return; 
            }
            
            // ‚≠ê NEW: Check if already joined
            if (userData && userData.joinedContests && userData.joinedContests[contestId]) {
                alert("Aap is contest mein pehle hi join kar chuke hain!");
                return;
            }
            
            isJoiningContest = true;

            const user = firebase.auth().currentUser;
            const joinBtn = event.currentTarget; // Get the button element that was clicked
            
            // UI Feedback
            const originalText = joinBtn.textContent;
            if (joinBtn) {
                joinBtn.textContent = 'Joining...';
                joinBtn.disabled = true;
            }

            // 2. Initial Checks
            if (!user || !userData) { 
                 alert("Kripya quiz shuru karne se pehle **login** karein‡•§");
                 isJoiningContest = false;
                 if (joinBtn) {
                     joinBtn.textContent = originalText;
                     joinBtn.disabled = false;
                 }
                 return;
            }
            
            const contest = contestsData[contestId];
            if (!contest) {
                alert("Error: Contest details load nahi hue‡•§ Kripya page refresh karein‡•§");
                isJoiningContest = false;
                if (joinBtn) {
                     joinBtn.textContent = originalText;
                     joinBtn.disabled = false;
                 }
                return;
            }

            // Check if contest has ended
            if (contest.drawTime && (new Date(contest.drawTime).getTime() <= Date.now())) {
                alert("Yeh contest samapt ho chuka hai‡•§");
                isJoiningContest = false;
                 if (joinBtn) {
                     joinBtn.textContent = 'Contest Ended';
                     joinBtn.classList.add('already-joined'); 
                     joinBtn.disabled = true;
                 }
                return;
            }

            // 3. Confirmation Popup
            const isConfirmed = confirm(`Kya aap "${contestName}" contest join karna chahte hain?\n\nHar question ke liye aapke paas 10 seconds honge.`);
            
            if (!isConfirmed) {
                isJoiningContest = false;
                if (joinBtn) {
                    joinBtn.textContent = originalText;
                    joinBtn.disabled = false;
                }
                return;
            }

            // 4. Create Submission Record and Proceed to Quiz Page
            try {
                 // Create a new submission record with isCompleted: false
                 const newSubmissionRef = getDBRef('submissions').push();
                 await newSubmissionRef.set({
                    userId: user.uid,
                    contestId: contestId,
                    totalPoints: 0,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    isCompleted: false, // Important: initially false
                    userName: userData.name || user.email
                 });
                 
                 // Also, increment slotsFilled count in the contest
                 const contestRef = getDBRef(`contests/${contestId}`);
                 await contestRef.child('spots_filled').transaction(currentValue => {
                    return (currentValue || 0) + 1;
                 });

                 // Update user's profile to mark contest as joined
                 await getDBRef(`users/${user.uid}/joinedContests/${contestId}`).set(true);

                 if (joinBtn) {
                    joinBtn.textContent = 'Starting Quiz...';
                 }
                
                // ‚≠ê Redirect to the quiz page with contest details
                isJoiningContest = false; // Release the lock before redirecting

                // Redirect to quiz page
                window.location.href = `quiz.html?contestId=${contestId}&name=${encodeURIComponent(contestName)}`;

            } catch (error) {
                 console.error("Error creating submission:", error);
                 alert("Quiz shuru karne mein error aaya‡•§ Kripya dobara koshish karein‡•§");
                 isJoiningContest = false;
                 if (joinBtn) {
                    joinBtn.textContent = originalText;
                    joinBtn.disabled = false;
                 }
            }
        }
        // ‚≠ê END UPDATED startQuiz FUNCTION ‚≠ê
        
        function nextQuestion() { /* ... next question logic (will be in quiz.html) ... */ }
        function closeResults() { /* ... close results logic (will be in quiz.html) ... */ }
        // Placeholder Share functions (IMPLEMENTATION REQUIRED)
        function shareViaWhatsApp() { 
            const referralLink = `${APP_DOWNLOAD_LINK}?ref=${userData.referralCode}`;
            const message = `Dreem15: Sapno ki Udaan! Join karein aur Free Quiz Contest khelein. Premium English Course bhi unlock karein. Mera Code: ${userData.referralCode}. Download: ${referralLink}`;
            window.open(`whatsapp://send?text=${encodeURIComponent(message)}`, '_blank');
        }
        function shareViaFacebook() { alert("Share via Facebook logic placeholder."); }
        function shareViaTelegram() { alert("Share via Telegram logic placeholder."); }
        function shareViaSMS() { alert("Share via SMS logic placeholder."); }
        function shareViaEmail() { alert("Share via Email logic placeholder."); }
        function copyReferralLink() { 
             const referralLink = `${APP_DOWNLOAD_LINK}?ref=${userData.referralCode}`;
             navigator.clipboard.writeText(referralLink).then(() => {
                alert("Referral Link copied!");
             });
        }
        function showComingSoon(feature) { alert(`${feature} feature coming soon!`); }

        // Added placeholder functions for My Contests and Leaderboard (Needs full implementation in future)
        function loadMyContestsData() {
            const container = document.getElementById('joined-contests-container');
             const user = firebase.auth().currentUser;
            
            if (!user || !userData || !userData.joinedContests || Object.keys(userData.joinedContests).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Aapne abhi tak koi contest join nahi kiya hai‡•§</p>';
                return;
            }

            container.innerHTML = '<p style="text-align: center; color: #999; margin-top: 10px; font-size: 0.85rem;">Loading your joined contests...</p>';

            // Fetch contest details for the joined contests
            const contestIds = Object.keys(userData.joinedContests);
            getDBRef('contests').once('value', (contestSnapshot) => {
                const contests = contestSnapshot.val() || {};
                let html = '';

                contestIds.forEach(contestId => {
                    const contest = contests[contestId];
                    if (contest) {
                        html += `
                            <div class="joined-contest-card">
                                <h4>${contest.name || 'Contest'} <span>${new Date(contest.drawTime || Date.now()).toLocaleDateString()}</span></h4>
                                <p>Prize Pool: <strong>‚Çπ${(contest.prize || 0).toLocaleString('en-IN')}</strong></p>
                                <p class="status" style="color: #ff0000;">Status: Pending Results (Placeholder)</p>
                            </div>
                        `;
                    }
                });

                if (html) {
                    container.innerHTML = html;
                } else {
                     container.innerHTML = '<p style="text-align: center; color: #666;">Aapke join kiye gaye contests ke details nahi mil paye‡•§</p>';
                }
            }, (error) => {
                 console.error("Error loading joined contests:", error.message);
                 container.innerHTML = '<p style="text-align: center; color: red;">Error loading joined contests.</p>';
            });
        }
        
        function loadLeaderboard() {
             const container = document.getElementById('leaderboard-container');
             container.innerHTML = '<p style="text-align: center; color: #666;">Loading global leaderboard...</p>';

             // Fetch top 10 users by total score (placeholder logic)
             getDBRef('users').orderByChild('totalScore').limitToLast(10).once('value', (snapshot) => {
                 const users = snapshot.val();
                 let html = '';
                 
                 if (users) {
                    const sortedUsers = Object.entries(users)
                        .map(([key, value]) => ({ id: key, ...value }))
                        .sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0)); // Sort by totalScore desc

                    const userUid = firebase.auth().currentUser ? firebase.auth().currentUser.uid : null;

                    sortedUsers.forEach((user, index) => {
                        const rank = index + 1;
                        const isCurrentUser = userUid === user.id;
                        const highlightClass = isCurrentUser ? 'user-highlight' : '';

                        html += `
                             <div class="leaderboard-entry ${highlightClass}">
                                <span class="leaderboard-entry-rank">${rank}</span>
                                <span class="leaderboard-entry-name">${user.name || user.email} ${isCurrentUser ? '(You)' : ''}</span>
                                <span class="leaderboard-entry-points">${(user.totalScore || 0).toFixed(0)} Pts</span>
                             </div>
                        `;
                    });

                    container.innerHTML = html;
                 } else {
                     container.innerHTML = '<p style="text-align: center; color: #666;">No users on the leaderboard yet.</p>';
                 }

             }, (error) => {
                 console.error("Error loading leaderboard:", error.message);
                 container.innerHTML = '<p style="text-align: center; color: red;">Error loading leaderboard.</p>';
             });
        }

    </script>
</body>
</html>